-- Add migration script here
CREATE SCHEMA IF NOT EXISTS "data";

-- CREATE EXTENSION IF NOT EXISTS pg_mooncake;

CREATE TABLE NOT EXISTS "data"."events"
(
    "id"          BIGINT                   NOT NULL,
    "actor_id"    BIGINT                   NOT NULL,
    "actor_login" TEXT                     NOT NULL,
    "repo_id"     BIGINT,
    "repo_name"   TEXT,
    "org_id"      BIGINT,
    "org_login"   TEXT,
    "event_type"  TEXT                     NOT NULL,
    "payload"     JSON                     NOT NULL DEFAULT '{}',
    "body"        TEXT,
    "abnormal"    INTEGER                  NOT NULL DEFAULT 0,
    "created_at"  TIMESTAMP WITH TIME ZONE NOT NULL,
    PRIMARY KEY ("id", "created_at")
);

CREATE TABLE IF NOT EXISTS "data"."repos"
(
    "repo_id"            BIGINT PRIMARY KEY       NOT NULL,
    "upstream_repo_name" TEXT                     NOT NULL,
    "repo_name"          TEXT                     NOT NULL,
    "upstream_marks"     JSONB                    NOT NULL DEFAULT '{}',
    "custom_marks"       JSONB                    NOT NULL DEFAULT '{}',
    "api"                JSONB                    NOT NULL DEFAULT '{}',
    "indexed"            BOOLEAN                  NOT NULL DEFAULT false,
    "created_at"         TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "api_updated_at"     TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "active_developers"  JSONB                    NOT NULL DEFAULT '[]',
    "star_history"       JSONB                    NOT NULL DEFAULT '[]'
);

CREATE TABLE IF NOT EXISTS "data"."actors"
(
    "actor_id"    BIGINT PRIMARY KEY       NOT NULL,
    "actor_login" TEXT,
    "created_at"  TIMESTAMP WITH TIME ZONE NOT NULL
);


CREATE TABLE IF NOT EXISTS data.events_2015 PARTITION OF data.events FOR VALUES FROM ('2015-01-01 00:00:00+00') TO ('2016-01-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2016 PARTITION OF data.events FOR VALUES FROM ('2016-01-01 00:00:00+00') TO ('2017-01-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2017 PARTITION OF data.events FOR VALUES FROM ('2017-01-01 00:00:00+00') TO ('2018-01-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2018 PARTITION OF data.events FOR VALUES FROM ('2018-01-01 00:00:00+00') TO ('2019-01-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2019 PARTITION OF data.events FOR VALUES FROM ('2019-01-01 00:00:00+00') TO ('2020-01-01 00:00:00+00');

CREATE TABLE IF NOT EXISTS data.events_2020_q1 PARTITION OF data.events FOR VALUES FROM ('2020-01-01 00:00:00+00') TO ('2020-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2020_q2 PARTITION OF data.events FOR VALUES FROM ('2020-04-01 00:00:00+00') TO ('2020-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2020_q3 PARTITION OF data.events FOR VALUES FROM ('2020-07-01 00:00:00+00') TO ('2020-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2020_q4 PARTITION OF data.events FOR VALUES FROM ('2020-10-01 00:00:00+00') TO ('2021-01-01 00:00:00+00');

CREATE TABLE IF NOT EXISTS data.events_2021_q1 PARTITION OF data.events FOR VALUES FROM ('2021-01-01 00:00:00+00') TO ('2021-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2021_q2 PARTITION OF data.events FOR VALUES FROM ('2021-04-01 00:00:00+00') TO ('2021-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2021_q3 PARTITION OF data.events FOR VALUES FROM ('2021-07-01 00:00:00+00') TO ('2021-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2021_q4 PARTITION OF data.events FOR VALUES FROM ('2021-10-01 00:00:00+00') TO ('2022-01-01 00:00:00+00');

CREATE TABLE IF NOT EXISTS data.events_2022_q1 PARTITION OF data.events FOR VALUES FROM ('2022-01-01 00:00:00+00') TO ('2022-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2022_q2 PARTITION OF data.events FOR VALUES FROM ('2022-04-01 00:00:00+00') TO ('2022-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2022_q3 PARTITION OF data.events FOR VALUES FROM ('2022-07-01 00:00:00+00') TO ('2022-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2022_q4 PARTITION OF data.events FOR VALUES FROM ('2022-10-01 00:00:00+00') TO ('2023-01-01 00:00:00+00');

CREATE TABLE IF NOT EXISTS data.events_2023_q1 PARTITION OF data.events FOR VALUES FROM ('2023-01-01 00:00:00+00') TO ('2023-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2023_q2 PARTITION OF data.events FOR VALUES FROM ('2023-04-01 00:00:00+00') TO ('2023-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2023_q3 PARTITION OF data.events FOR VALUES FROM ('2023-07-01 00:00:00+00') TO ('2023-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2023_q4 PARTITION OF data.events FOR VALUES FROM ('2023-10-01 00:00:00+00') TO ('2024-01-01 00:00:00+00');

CREATE TABLE IF NOT EXISTS data.events_2024_q1 PARTITION OF data.events FOR VALUES FROM ('2024-01-01 00:00:00+00') TO ('2024-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2024_q2 PARTITION OF data.events FOR VALUES FROM ('2024-04-01 00:00:00+00') TO ('2024-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2024_q3 PARTITION OF data.events FOR VALUES FROM ('2024-07-01 00:00:00+00') TO ('2024-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2024_q4 PARTITION OF data.events FOR VALUES FROM ('2024-10-01 00:00:00+00') TO ('2025-01-01 00:00:00+00');


CREATE TABLE IF NOT EXISTS data.events_2025_01 PARTITION OF data.events FOR VALUES FROM ('2025-01-01 00:00:00+00') TO ('2025-02-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_02 PARTITION OF data.events FOR VALUES FROM ('2025-02-01 00:00:00+00') TO ('2025-03-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_03 PARTITION OF data.events FOR VALUES FROM ('2025-03-01 00:00:00+00') TO ('2025-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_04 PARTITION OF data.events FOR VALUES FROM ('2025-04-01 00:00:00+00') TO ('2025-05-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_05 PARTITION OF data.events FOR VALUES FROM ('2025-05-01 00:00:00+00') TO ('2025-06-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_06 PARTITION OF data.events FOR VALUES FROM ('2025-06-01 00:00:00+00') TO ('2025-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_07 PARTITION OF data.events FOR VALUES FROM ('2025-07-01 00:00:00+00') TO ('2025-08-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_08 PARTITION OF data.events FOR VALUES FROM ('2025-08-01 00:00:00+00') TO ('2025-09-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_09 PARTITION OF data.events FOR VALUES FROM ('2025-09-01 00:00:00+00') TO ('2025-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_10 PARTITION OF data.events FOR VALUES FROM ('2025-10-01 00:00:00+00') TO ('2025-11-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_11 PARTITION OF data.events FOR VALUES FROM ('2025-11-01 00:00:00+00') TO ('2025-12-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_12 PARTITION OF data.events FOR VALUES FROM ('2025-12-01 00:00:00+00') TO ('2026-01-01 00:00:00+00');

CREATE TABLE IF NOT EXISTS data.events_2025_01 PARTITION OF data.events FOR VALUES FROM ('2026-01-01 00:00:00+00') TO ('2026-02-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_02 PARTITION OF data.events FOR VALUES FROM ('2026-02-01 00:00:00+00') TO ('2026-03-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_03 PARTITION OF data.events FOR VALUES FROM ('2026-03-01 00:00:00+00') TO ('2026-04-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_04 PARTITION OF data.events FOR VALUES FROM ('2026-04-01 00:00:00+00') TO ('2026-05-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_05 PARTITION OF data.events FOR VALUES FROM ('2026-05-01 00:00:00+00') TO ('2026-06-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_06 PARTITION OF data.events FOR VALUES FROM ('2026-06-01 00:00:00+00') TO ('2026-07-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_07 PARTITION OF data.events FOR VALUES FROM ('2026-07-01 00:00:00+00') TO ('2026-08-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_08 PARTITION OF data.events FOR VALUES FROM ('2026-08-01 00:00:00+00') TO ('2026-09-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_09 PARTITION OF data.events FOR VALUES FROM ('2026-09-01 00:00:00+00') TO ('2026-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_10 PARTITION OF data.events FOR VALUES FROM ('2026-10-01 00:00:00+00') TO ('2026-11-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_11 PARTITION OF data.events FOR VALUES FROM ('2026-11-01 00:00:00+00') TO ('2026-12-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS data.events_2025_12 PARTITION OF data.events FOR VALUES FROM ('2026-12-01 00:00:00+00') TO ('2027-01-01 00:00:00+00');

-- CALL mooncake.create_table('events_iceberg', 'events');


CREATE TABLE IF NOT EXISTS ecosystems
(
    id          BIGSERIAL PRIMARY KEY,
    name        TEXT                                    NOT NULL,
    icon        TEXT                     DEFAULT ''     NOT NULL,
    description TEXT                     DEFAULT ''     NOT NULL,
    active      BOOLEAN                  DEFAULT FALSE  NOT NULL,
    created_at  TIMESTAMP WITH TIME ZONE DEFAULT NOW()  NOT NULL,
    updated_at  TIMESTAMP WITH TIME ZONE DEFAULT NOW()  NOT NULL,
    score       NUMERIC                  DEFAULT 0      NOT NULL,
    kind        TEXT                     DEFAULT ''     NOT NULL
);